---
title: 'Making a Todo Example for My Framework'
summary: 'About @erickmerchant/framework'
timeZone: 'America/Los_Angeles'
---
This year I started working on a framework that I published as [@erickmerchant/framework](https://www.npmjs.com/package/@erickmerchant/framework) to npm. It's not meant to be a serious contender in the world of frameworks, but I intend to use it and keep improving it. It's inspired by React and others, but much simpler. I first saw the term "data down, actions up" with yo-yo and I'd describe it as such. It doesn't come with a built-in way of outputting html, but I've been using it with [bel](https://www.npmjs.com/package/bel) and [nanomorph](https://www.npmjs.com/package/nanomorph). This month I've been working a lot on making a Todo example, as in TodoMVC. Below are the three JavaScript files for that with a lot of comments.

## index.js

``` javascript
const framework = require('@erickmerchant/framework')
const store = require('./store')
const component = require('./component')
const diff = require('nanomorph')
const target = document.querySelector('main')

/* framework is called with a settings object. Four things are required. store provides our state. component provides our dom element. diff provides a means to apply changes to that element. target is the element on the page that will get replaced with what the component returns. framework returns a function that's called with a callback that sets up a hash router.
*/
framework({target, store, component, diff})(function ({dispatch}) {
  window.onhashchange = function () {
    dispatch('set-hash', {hash: window.location.hash})
  }

  dispatch('set-hash', {hash: window.location.hash})
})
```

## store.js

``` javascript
module.exports = function (seed) {
  /* seed is called with the initial state */
  seed({
    todos: null,
    value: '',
    completed: 0,
    current: null,
    next: 0,
    hash: '#/all'
  })

  /* a function is returned that gets called anytime dispatch is called. It will get called with commit as the first argument followed by all the things dispatch was called with */
  return function (commit, action, args) {
    /* commit is how the state is changed. What it returns becomes the new state */
    commit(function (state) {
      let index

      switch (action) {
        case 'set-value':
          state.value = args.title
          break

        case 'set-current':
          state.current = args.todo
          break

        case 'set-hash':
          state.hash = typeof args.hash === 'string' && args.hash !== '' ? args.hash : '#/all'
          break

        case 'unset-current':
          state.current = null
          break

        case 'add-todo':
          state.todos.push({
            title: args.title,
            completed: false
          })
          break

        case 'edit-todo':
          index = state.todos.indexOf(args.todo)

          if (index > -1) {
            state.todos[index].title = args.title
          }
          break

        case 'set-all-todos-completedness':
          state.todos.forEach((todo) => {
            todo.completed = args.completed
          })

          if (args.completed) {
            state.completed = state.todos.length
          } else {
            state.completed = 0
          }
          break

        case 'set-todo-completedness':
          index = state.todos.indexOf(args.todo)

          if (index > -1) {
            state.todos[index].completed = args.completed

            state.completed += (args.completed ? 1 : -1)
          }
          break

        case 'remove-todo':
          index = state.todos.indexOf(args.todo)

          if (index > -1) {
            if (state.todos[index].completed) {
              state.completed -= 1
            }

            state.todos.splice(index, 1)
          }
          break

        case 'remove-completed-todos':
          state.todos = state.todos.filter((todo) => !todo.completed)

          state.completed = 0
          break
      }

      /* Every time the state changes it is stored in localStorage */
      return storage(state)
    })
  }
}

const storageKey = 'todo-data'

function storage (state = {}) {
  if (state.todos == null) {
    const stored = window.localStorage.getItem(storageKey)
    let data = {}

    if (stored) {
      try {
        data = JSON.parse(stored)
      } catch (e) {
        console.error(e)
      }
    }

    state.todos = data.todos || []
    state.next = data.next || 0

    state.completed = state.todos.filter((todo) => todo.completed).length
  }

  window.localStorage.setItem(storageKey, JSON.stringify({
    todos: state.todos,
    next: state.next
  }))

  return state
}
```

## component.js

``` javascript
const html = require('bel')
const ENTER_KEY = 13
const ESCAPE_KEY = 27

/* The component gets called with the current state, dispatch which is a means to signal change, and next which is a way to interact with the page after a render */
module.exports = function ({state, dispatch, next}) {
  /* After the diff is called if an item is being edited, focus it */
  next(function ({target}) {
    const input = target.querySelector('input.edit')

    if (input) {
      input.focus()

      input.value = input.value
    }
  })

  return html`<main>
    <section class="todoapp">
      <header class="header">
        <h1>todos</h1>
        <input class="new-todo"
          autofocus autocomplete="off"
          placeholder="What needs to be done?"
          value="${state.value}"
          onkeyup=${
            function (e) {
              /* If the enter key is pressed add a todo and clear the current value. Otherwise save what was entered to value, because when the state changes the input should not clear */
              const title = this.value
              if (e.keyCode === ENTER_KEY && this.value) {
                dispatch('add-todo', {title})

                dispatch('set-value', {title: ''})
              } else {
                dispatch('set-value', {title})
              }
            }
        } />
      </header>
      ${
        state.todos.length > 0
        ? html`<section class="main">
            <input id="toggle-all" class="toggle-all" type="checkbox" onchange=${
              function (e) {
                /* If there are any incomplete todo items, set them as complete. If all are completed set all as incomplete. */
                const completed = !(state.todos.length - state.completed === 0)
                dispatch('set-all-todos-completedness', {completed})
              }
            } checked="${state.todos.length - state.completed === 0}" autofocus />
            <label for="toggle-all">Mark all as complete</label>
            <ul class="todo-list">
              ${state.todos
                .filter((todo) => state.hash === '#/all' || (state.hash === '#/active' && !todo.completed) || (state.hash === '#/completed' && todo.completed))
                .map((todo) => html`
                <li class="todo ${todo.completed ? 'completed' : ''} ${state.current === todo ? 'editing' : ''}">
                  <div class="view">
                    <input class="toggle" type="checkbox" onchange=${
                      function (e) {
                        /* Toggle this todo item's completedness */
                        e.preventDefault()

                        const completed = this.checked

                        dispatch('set-todo-completedness', {todo, completed})
                      }
                    } checked="${todo.completed}" />
                    <label ondblclick=${
                      function () {
                        /* Edit this todo item */
                        dispatch('set-current', {todo})
                      }
                    }>${todo.title}</label>
                    <button class="destroy" onclick=${
                      function () {
                        /* Remove this todo item */
                        dispatch('remove-todo', {todo})
                      }
                    }></button>
                  </div>
                  ${
                    state.current === todo
                    ? html`<input class="edit" type="text" value="${todo.title}" onkeyup=${
                        function (e) {
                          switch (e.keyCode) {
                            /* The user is done editing. Save changes and exit out of edited this todo item. */
                            case ENTER_KEY:
                              dispatch('unset-current')

                              if (this.value) {
                                const title = this.value

                                dispatch('edit-todo', {todo, title})
                              } else {
                                dispatch('remove-todo', {todo})
                              }
                              break

                            /* Just exit out of editing */
                            case ESCAPE_KEY:
                              dispatch('unset-current')
                              break
                          }
                        }
                      } />`
                    : ''
                  }
                </li>`)}
            </ul>
          </section>`
        : ''
      }
      ${
        state.todos.length > 0
        ? html`<footer class="footer">
            <span class="todo-count">
              <strong>${state.todos.length - state.completed}</strong> ${state.todos.length - state.completed !== 1 ? ' items' : ' item'} left
            </span>
            <ul class="filters">
              <li><a href="#/all" class="${state.hash === '#/all' ? 'selected' : ''}">All</a></li>
              <li><a href="#/active" class="${state.hash === '#/active' ? 'selected' : ''}">Active</a></li>
              <li><a href="#/completed" class="${state.hash === '#/completed' ? 'selected' : ''}">Completed</a></li>
            </ul>
            ${
              state.completed > 0
              ? html`<button class="clear-completed" onclick=${
                  function () {
                    /* Remove all the completed ones */
                    dispatch('remove-completed-todos')
                  }
                }>
                  Clear completed
                </button>`
              : ''
            }
          </footer>`
        : ''
      }
    </section>
    <footer class="info">
      <p>Double-click to edit a todo</p>
      <p>Created by <a href="http://erickmerchant.com">Erick Merchant</a></p>
      <p>View the source <a href="https://github.com/erickmerchant/framework-todo">here</a></p>
    </footer>
  </main>`
}
```

View the live version [here](http://todo.erickmerchant.com).
